# REST API

Проект организован в форме монорепозитория с использование инструмента <a alt="Nx logo" href="https://nx.dev" target="_blank" rel="noreferrer"><img src="https://raw.githubusercontent.com/nrwl/nx/master/images/nx-logo.png" width="45"></a> и построен
с помощью фреймворка **nest**.

В проекте содержатся следующие сервисы:
* **users**
* **workouts**

### Список переменных окружения приложения:
Примеры переменных окружения содержатся в директории ./environments.

* MONGO_DB=fitfriends-users - наименование базы данных для хранения списка подписчиков почтовой рассылки
* MONGO_HOST=localhost - адрес подключения к базе данных
* MONGO_PORT=27018 - порт подключения к базе данных
* MONGO_USER=admin - имя пользователя подключающегося к базе данных
* MONGO_PASSWORD=test - пароль пользователя
* MONGO_AUTH_BASE=admin - имя базы данных, связанное с учетными данными пользователя
* JWT_AT_SECRET=secret - секрет для подписи токена
* JWT_AT_EXPIRES_IN=15m - время жизни токена доступа

* JWT_RT_SECRET=refreshsecret - секрет для подписи токена обновления
* JWT_RT_EXPIRES_IN=7d - время жизни токена обновления


### Запуск сервисов.

Сервисы монорепозитория располагаются по пути [./apps](./apps/).

Для удобства работы над проектом используются инструменты из **Node.js** и **npm**. Все необходимые настройки произведены. Убедитесь, что на рабочем компьютере установлен актуальный LTS релиз Node.js**. Затем, в терминале, перейдите в корневую директорию монорепозитория **/backend** и _единожды_ запустите команду:

```bash
npm install
```

Команда запустит процесс установки зависимостей проекта из **npm**.

После установки зависимостей проекта, в каждом **сервисе** имеется **docker-compose.yml** для запуска окружения неоходимого для работы каждого сервиса, запустите **docker daemon**. Перейдите в директорию сервиса, например **/backend/apps/users**

Далее выполните команду:

```bash
docker-compose up -d
```
Данная команда загрузит необходимые образы из хранилища образов, создаст  соответствующие контейнеры.

Запускает конейнеры с базой данных и ее веб клиентом доступным на хосте и порте взависимости от значения переменных окружения.

После запуска соответствующего окружения база данных доступна для содинения с сервисом:

```bash
nx run users:serve
```

Команда собирает в режиме разработки сервис в директорию **/backend/dist/<имя сервиса>** и запускает main.js файл рабочего сервиса.

---

Для работы сервиса **workouts** используется ORM Prisma для удобной работы с базой данных PostgreSQl. После запуска окружения для работы сервиса через **docker** выполните команды, незабыв установить переменную оружения указанную в **.env.example** директории **/workouts/prisma**.

```bash
nx run workouts:db-migrate
```
Данная команда подключит prisma к **portgres** и сформирует таблицы данных на основании схемы **/prisma/schema.prisma**. 
Далее выполните команду 

```bash
nx run workouts:db-generate
```

Команда сгенерирует prisma client в директории node_modules для архитектуры cpu по умолчанию, аппаратная часть которого выполняет данную команду, для генерации под различные архитектуры набора команд cpu используется поле **binaryTargets** генератора клиента **schema.prisma**.
После выполнения всего вышеуказанного можно запускать сервис.

```bash
nx run workouts:serve
```
---

### Сценарии

Все сценарии работы с **NX** приведены в файле **project.json** в поле target соответствующего сервиса, запуск осуществляется командой
```bash
nx run <имя сервиса>:<сценарий поля target>
```
