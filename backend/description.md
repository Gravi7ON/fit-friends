# REST API

Проект организован в форме монорепозитория с использование инструмента <a alt="Nx logo" href="https://nx.dev" target="_blank" rel="noreferrer"><img src="https://raw.githubusercontent.com/nrwl/nx/master/images/nx-logo.png" width="45"></a> и построен
с помощью фреймворка **nest**.

В проекте содержатся следующие сервисы:

- **users**
- **workouts**
- **notify**

### Список переменных окружения приложения:

Примеры переменных окружения содержатся в директории ./environments.

- MONGO_DB - наименование базы данных для хранения списка подписчиков почтовой рассылки
- MONGO_HOST - адрес подключения к базе данных
- MONGO_PORT - порт подключения к базе данных
- MONGO_USER - имя пользователя подключающегося к базе данных
- MONGO_PASSWORD - пароль пользователя
- MONGO_AUTH_BASE - имя базы данных, связанное с учетными данными пользователя

- JWT_AT_SECRET - секрет для подписи токена
- JWT_AT_EXPIRES_IN - время жизни токена доступа

- JWT_RT_SECRET - секрет для подписи токена обновления
- JWT_RT_EXPIRES_IN - время жизни токена обновления

- MAIL_SMTP_HOST - адрес подключения к почтовому серверу
- MAIL_SMTP_PORT- порт подключения к почтовому серверу
- MAIL_USER_NAME- имя подключения к почтовому серверу
- MAIL_USER_PASSWORD - пароль подключения к постовому серверу
- MAIL_FROM - почта по умолчанию адресанта

- RABBIT_USER - логин подключения к rabbitmq
- RABBIT_PASSWORD- пароль подключения к rabbitmq
- RABBIT_HOST- адрес подключения к rabbitmq
- RABBIT_NOTIFY_SERVICE_WORKOUTS_QUEUE - подключение сервиса уведомлений к очереди тренировок
- RABBIT_WORKOUTS_SERVICE_WORKOUTS_QUEUE - подключение сервиса тренировок к очереди тренировок

- REDIS_HOST - адрес подключения к redis
- REDIS_PORT - порт подключения к redis

### Запуск сервисов.

Сервисы монорепозитория располагаются по пути [./apps](./apps/).

Для удобства работы над проектом используются инструменты из **Node.js** и **npm**. Все необходимые настройки произведены. Убедитесь, что на рабочем компьютере установлен актуальный LTS релиз Node.js**. Затем, в терминале, перейдите в корневую директорию монорепозитория **/backend\*\* и _единожды_ запустите команду:

```bash
npm install
```

Команда запустит процесс установки зависимостей проекта из **npm**.

После установки зависимостей проекта, в каждом **сервисе** имеется **docker-compose.yml** для запуска окружения неоходимого для работы каждого сервиса, запустите **docker daemon**. Перейдите в директорию сервиса, например **/backend/apps/users**

Далее выполните команду:

```bash
docker-compose up -d
```

Данная команда загрузит необходимые образы из хранилища образов, создаст соответствующие контейнеры.

Запускает конейнеры с базой данных и ее веб клиентом доступным на хосте и порте взависимости от значения переменных окружения.

После запуска соответствующего окружения база данных доступна для содинения с сервисом:

```bash
nx run users:serve
```

Команда собирает в режиме разработки сервис в директорию **/backend/dist/<имя сервиса>** и запускает main.js файл рабочего сервиса.

---

Для работы сервиса **workouts** используется ORM Prisma для удобной работы с базой данных PostgreSQl. После запуска окружения для работы сервиса через **docker** выполните команды, незабыв установить переменные оружения указанную в **.env.example** директории **/workouts/prisma**.

```bash
nx run workouts:db-migrate
```

Данная команда подключит prisma к **portgres** и сформирует таблицы данных на основании схемы **/prisma/schema.prisma**.
Далее выполните команду

```bash
nx run workouts:db-generate
```

Команда сгенерирует prisma client в директории node_modules для архитектуры cpu по умолчанию, аппаратная часть которого выполняет данную команду, для генерации под различные архитектуры набора команд cpu используется поле **binaryTargets** генератора клиента **schema.prisma**.
После выполнения всего вышеуказанного можно запускать сервис.

```bash
nx run workouts:serve
```


Заполнить таблицу спортзалов.
```bash
nx run workouts:db-fill
```

---

### Сценарии

Все сценарии работы с **NX** приведены в файле **project.json** в поле target соответствующего сервиса, запуск осуществляется командой

```bash
nx run <имя сервиса>:<сценарий поля target>
```
